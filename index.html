<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Morse Exam - Student</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body{margin:0;height:100vh;background:#000;color:#0f0;font-family:'Courier New',monospace;display:flex;flex-direction:column;justify-content:center;align-items:center;overflow:hidden;-webkit-tap-highlight-color:transparent;}
        #word{font-size:15vmin;letter-spacing:2vmin;margin-bottom:1vh;text-shadow:0 0 4vmin #0f0;text-align:center;margin-top:5vh;}
        #timer{font-size:10vmin;margin-bottom:2vh;color:#0ff;font-weight:bold;}
        #currentInput{font-size:10vmin;margin-bottom:2vh;color:#0ff;min-height:12vmin;}
        #inputLine{font-size:12vmin;letter-spacing:3vmin;margin-bottom:5vh;text-align:center;}
        #button{width:35vmin;height:35vmin;border-radius:50%;background:#111;border:1.5vmin solid #0f0;box-shadow:0 0 6vmin #0f0;cursor:pointer;user-select:none;font-size:5vmin;font-weight:bold;display:flex;align-items:center;justify-content:center;}
        #button.pressed{background:#0f0;color:#000;box-shadow:0 0 15vmin #0f0;transform:scale(0.9);}
        .wrong{animation:shake 0.6s;background:#600;}
        @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-2vmin)}75%{transform:translateX(2vmin)}}
        .info, .stats, .exam-timer{position:absolute;top:2vh;font-size:3vmin;color:#0a0;background:#111;padding:1.5vmin;border:0.3vmin solid #0f0;border-radius:1.5vmin;z-index:10;}
        .info{left:2vh;} .stats{right:2vh;text-align:right;} 
        .exam-timer { top: auto; bottom: 2vh; left: 50%; transform: translateX(-50%); color: #ff0; font-size: 4vmin; font-weight: bold;}

        /* Login Screen */
        #loginOverlay {position: fixed; top:0; left:0; width:100%; height:100%; background: #000; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center;}
        input { font-size: 5vmin; padding: 2vmin; background: #111; color: #0f0; border: 2px solid #0f0; outline: none; text-align: center; margin-bottom: 20px; border-radius: 10px;}
        button.start-btn { font-size: 5vmin; padding: 2vmin 5vmin; background: #0f0; color: #000; border: none; cursor: pointer; font-weight: bold; border-radius: 10px;}
    </style>
</head>
<body>

<div id="loginOverlay">
    <h1 style="color:#0f0; font-size:6vmin; margin-bottom:10px;">MORSE EXAM</h1>
    <p style="color:#0a0; font-size:3vmin; margin-bottom:30px;">20 daqiqa vaqt beriladi</p>
    <input type="text" id="usernameInput" placeholder="Ism Familiya" autocomplete="off">
    <button class="start-btn" onclick="startGameSession()">BOSHLASH</button>
</div>

<div class="info">Short → .<br>Hold → —</div>
<div class="stats">Word: <span id="scoreVal" style="color:#fff">0</span><br>Fail: <span id="errorVal" style="color:#f00">0</span></div>
<div class="exam-timer">Time: <span id="globalTimer">20:00</span></div>

<div id="word">WAIT</div>
<div id="timer">5.0</div>
<div id="currentInput"></div>
<div id="inputLine">_ _ _</div>
<div id="button">PRESS</div>

<script>
    // --- FIREBASE CONFIG START ---
    // SHU YERGA FIREBASE KONSOLEDAN OLGAN KODINGIZNI QO'YING
    const firebaseConfig = {
        apiKey: "AIzaSyAjbCP0Felmv9x44t6xKUG1SJFDOHSrXjg",
        authDomain: "morcetest.firebaseapp.com",
        projectId: "morcetest",
        storageBucket: "morcetest.firebasestorage.app",
        messagingSenderId: "4777699748",
        appId: "1:4777699748:web:d9fdbe920e20f7fe5cf931",
        measurementId: "G-166HN8K4R5"
    };
    // --- FIREBASE CONFIG END ---

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let studentId = null;
    let examActive = false;
    let globalTimeLeft = 20 * 60; // 20 daqiqa sekundda

    const words = ["HELLO","WORLD","MORSE","CODE","RADIO","YES","YOU","FRIEND","HOME","LOVE","PEACE","GOOD","NIGHT","STAR","MOON","SKY","WAVE","TEST","SOS"];
    const morseToLetter = {'.-':'A', '-...':'B', '-.-.':'C', '-..':'D', '.':'E', '..-.':'F', '--.':'G', '....':'H', '..':'I', '.---':'J', '-.-':'K', '.-..':'L', '--':'M', '-.':'N', '---':'O', '.--.':'P', '--.-':'Q', '.-.':'R', '...':'S', '-':'T', '..-':'U', '...-':'V', '.--':'W', '-..-':'X', '-.--':'Y', '--..':'Z'};

    let currentWord = "", guessed = [], currentCode = "", timer = null, timeLeft = 5.0;
    let score = 0, errors = 0;
    
    const wordEl = document.getElementById("word");
    const timerEl = document.getElementById("timer");
    const currentEl = document.getElementById("currentInput");
    const inputEl = document.getElementById("inputLine");
    const button = document.getElementById("button");
    const scoreEl = document.getElementById("scoreVal");
    const errorEl = document.getElementById("errorVal");
    const globalTimerEl = document.getElementById("globalTimer");
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function startGameSession() {
        const name = document.getElementById("usernameInput").value.trim();
        if(!name) return alert("Iltimos, ismingizni yozing!");
        
        // Bazaga yangi user yaratish
        const newRef = database.ref('results').push();
        studentId = newRef.key;
        
        newRef.set({
            name: name,
            score: 0,
            errors: 0,
            status: "Started",
            timestamp: Date.now()
        });

        document.getElementById("loginOverlay").style.display = "none";
        examActive = true;
        
        // Global taymerni ishga tushirish
        setInterval(() => {
            if(!examActive) return;
            globalTimeLeft--;
            let m = Math.floor(globalTimeLeft / 60);
            let s = globalTimeLeft % 60;
            globalTimerEl.textContent = `${m}:${s<10?'0':''}${s}`;
            
            if(globalTimeLeft <= 0) finishExam();
        }, 1000);

        audioCtx.resume();
        newWord();
    }

    function updateDB() {
        if(studentId) {
            database.ref('results/' + studentId).update({
                score: score,
                errors: errors
            });
        }
    }

    function finishExam() {
        examActive = false;
        clearInterval(timer);
        wordEl.textContent = "TIME UP!";
        inputEl.textContent = "Imtihon tugadi";
        button.style.display = "none";
        database.ref('results/' + studentId).update({ status: "Finished" });
    }

    function play(dur, freq=800){
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        o.frequency.value = freq; o.type = "sine"; g.gain.value = 0.5;
        o.start(); o.stop(audioCtx.currentTime + dur/1000);
    }

    function startTimer(){
        if(!examActive) return;
        clearInterval(timer);
        timeLeft = 5.0;
        timerEl.textContent = "5.0";
        timerEl.style.color = "#0ff";

        timer = setInterval(() => {
            timeLeft -= 0.1;
            timerEl.textContent = timeLeft.toFixed(1);
            if(timeLeft <= 1.0) timerEl.style.color = "#ff0";
            if(timeLeft <= 0){
                clearInterval(timer);
                checkAfterTimeout(); 
            }
        }, 100);
    }

    function checkAfterTimeout(){
        const expectedLetter = currentWord[guessed.length];
        const enteredLetter = morseToLetter[currentCode];

        if(enteredLetter === expectedLetter){
            guessed.push(expectedLetter);
            currentCode = "";
            currentEl.textContent = "";
            updateLine();
            play(300, 1200);
            
            if(guessed.length === currentWord.length){
                score++;
                scoreEl.textContent = score;
                updateDB(); // Bazani yangilash
                setTimeout(newWord, 1200);
            } else {
                setTimeout(startTimer, 800);
            }
        } else {
            wrong();
        }
    }

    function wrong(){
        errors++;
        errorEl.textContent = errors;
        updateDB(); // Bazani yangilash
        
        document.body.classList.add("wrong");
        play(600, 300);
        setTimeout(() => {
            document.body.classList.remove("wrong");
            guessed = [];
            currentCode = "";
            currentEl.textContent = "";
            updateLine();
            startTimer();
        }, 1000);
    }

    function newWord(){
        if(!examActive) return;
        const i = Math.floor(Math.random() * words.length);
        currentWord = words[i]; // So'zlar tugamasligi uchun random turaversin
        guessed = [];
        currentCode = "";
        wordEl.textContent = currentWord;
        updateLine();
        currentEl.textContent = "";
        startTimer();
    }

    function updateLine(){
        let s = "";
        for(let i = 0; i < currentWord.length; i++) s += (guessed[i] || "_") + " ";
        inputEl.textContent = s.trim();
    }

    let pressStart = 0; const LONG_PRESS = 500;
    button.addEventListener("mousedown", e => { if(examActive){ pressStart = Date.now(); button.classList.add("pressed"); }});
    button.addEventListener("mouseup", e => { if(!button.classList.contains("pressed") || !examActive) return; const dur = Date.now() - pressStart; button.classList.remove("pressed"); const sym = dur < LONG_PRESS ? "." : "-"; currentCode += sym; currentEl.textContent = currentCode.replace(/\./g,"• ").replace(/-/g,"— ").trim(); play(dur < LONG_PRESS ? 120 : 360, 900); });
    button.addEventListener("touchstart", e=>{e.preventDefault(); if(examActive){ pressStart = Date.now(); button.classList.add("pressed");}});
    button.addEventListener("touchend", e=>{e.preventDefault(); if(!button.classList.contains("pressed") || !examActive) return; const dur = Date.now() - pressStart; button.classList.remove("pressed"); const sym = dur < LONG_PRESS ? "." : "-"; currentCode += sym; currentEl.textContent = currentCode.replace(/\./g,"• ").replace(/-/g,"— ").trim(); play(dur < LONG_PRESS ? 120 : 360, 900); });
</script>
</body>
</html>
